#!/usr/bin/env node

// Dependencies
var CliGhCal = require("../lib")
  , AnsiParser = require("ansi-parser")
  , Logger = require("bug-killer")
  , CLP = require("clp")
  , Package = require("../package")
  , Moment = require("moment")
  , Typpy = require("typpy")
  ;

// Parse the command line arguments
var dataOpt = new CLP.Option(["d", "data"], "Provide the JSON data in this format: [[\"03/14/2015\", 5]]", "data", [])
  , themeOpt = new CLP.Option(["t", "theme"], "The theme to use.", "theme", "DARK")
  , startOpt = new CLP.Option(["s", "start"], "The start date.", "date",  new Moment().subtract(1, "years"))
  , endOpt = new CLP.Option(["e", "end"], "The end date.", "date", new Moment())
  , noAnsiOpt = new CLP.Option(["n", "no-ansi"], "Forces the tool not to use ANSI styles.")
  , lightOpt = new CLP.Option(["l", "light"], "Enables the light theme.")
  , firstDatOpt = new CLP.Option(["f", "first-day"], "Sets the first day (e.g. 'Sun').", "day")
  , parser = new CLP({
        name: "CliGhCal"
      , version: Package.version
      , exe: Package.name
      , examples: [
            "cli-gh-cal -d '[[\"03/14/2015\", 5]]' -t none"
          , "cli-gh-cal -d '[[\"03/14/2015\", 5]]' -s '1 January 2014'"
        ]
      , docs_url: Package.homepage
      , process: true
    }, [
        dataOpt
      , themeOpt
      , startOpt
      , endOpt
      , noAnsiOpt
      , lightOpt
      , firstDatOpt
    ])
  , options = null
  ;

if (Typpy(dataOpt.value) === "string") {
    try {
        dataOpt.value = JSON.parse(dataOpt.value);
    } catch (e) {
        return Logger.log("Cannot parse the input data. Make sure you pass valid JSON.", "error");
    }
}

// Create the options
options = {
    start: startOpt.is_provided ? Moment(startOpt.value) : Moment().subtract(1, "years")
  , end: endOpt.is_provided ? Moment(endOpt.value) : Moment()
  , theme: /LIGHT|DARK/.test(themeOpt.value) ? themeOpt.value : null
  , firstDay: firstDatOpt.value || undefined
};

// Validate the dates
if (!options.start || !options.start.isValid()) {
    options.start = Moment().subtract(1, "years");
    Logger.log("Invalid start date. Using default instead (" + options.start.format("LL") + ").", "warn");
}

if (!options.end || !options.end.isValid()) {
    options.end = Moment();
    Logger.log("Invalid end date. Using default instead (" + options.end.format("LL") + ").", "warn");
}

// Show the graph
process.stdout.write(CliGhCal(dataOpt.value, options) + "\n");
